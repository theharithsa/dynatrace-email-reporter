name: CI Pipeline

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      trace_id: ${{ steps.start_trace.outputs.trace_id }}
      parent_span_id: ${{ steps.start_trace.outputs.parent_span_id }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Start Build Trace
        id: start_trace
        run: |
          node trace-cli.js start --step="build" > trace_output.txt
          echo "trace_id=$(grep trace_id trace_output.txt | cut -d'=' -f2)" >> $GITHUB_OUTPUT
          echo "parent_span_id=$(grep parent_span_id trace_output.txt | cut -d'=' -f2)" >> $GITHUB_OUTPUT

      - name: Start Install Dependencies
        id: start_install
        run: |
          node trace-cli.js start-child --step="Install Dependencies" --trace-id=${{ steps.start_trace.outputs.trace_id }} --parent-span-id=${{ steps.start_trace.outputs.parent_span_id }} > install_output.txt
          echo "span_id=$(grep span_id install_output.txt | cut -d'=' -f2)" >> $GITHUB_OUTPUT

      - name: Install Dependencies
        run: npm install

      - name: End Install Dependencies
        run: |
          node trace-cli.js end-child --step="Install Dependencies" --trace-id=${{ steps.start_trace.outputs.trace_id }} --span-id=${{ steps.start_install.outputs.span_id }}

      - name: End Build Trace
        run: node trace-cli.js end --step="Build Done"

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Start Deploy Trace
        id: start_deploy
        run: |
          node trace-cli.js start --step="deploy" > trace_output.txt
          echo "trace_id=$(grep trace_id trace_output.txt | cut -d'=' -f2)" >> $GITHUB_OUTPUT
          echo "parent_span_id=$(grep parent_span_id trace_output.txt | cut -d'=' -f2)" >> $GITHUB_OUTPUT

      - name: Start Azure Deployment
        id: start_az
        run: |
          node trace-cli.js start-child --step="Azure Deployment" --trace-id=${{ steps.start_deploy.outputs.trace_id }} --parent-span-id=${{ steps.start_deploy.outputs.parent_span_id }} > az_output.txt
          echo "span_id=$(grep span_id az_output.txt | cut -d'=' -f2)" >> $GITHUB_OUTPUT

      - name: Azure Deploy Task
        run: echo "Pretending to deploy..."

      - name: End Azure Deployment
        run: |
          node trace-cli.js end-child --step="Azure Deployment" --trace-id=${{ steps.start_deploy.outputs.trace_id }} --span-id=${{ steps.start_az.outputs.span_id }}

      - name: End Deploy Trace
        run: node trace-cli.js end --step="Deploy Done"
