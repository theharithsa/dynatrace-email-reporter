D### **CI/CD + OTel Trace/Log Integration: Issues & Resolutions Log**

| **#** | **Issue/Request**                                         | **Description / Context**                                                                                                                               | **Resolution / Steps Taken**                                                                                                                                                                                                                                                                          |   |                                                                                                                                                   |
| ----- | --------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | - | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1     | *Initial Setup: OTel pipeline trace in GitHub Actions*    | Needed end-to-end trace and log correlation for Node.js app CI/CD pipeline, with each step as a span and logs sent to Dynatrace.                        | Wrote `pipeline-trace.js` using OpenTelemetry Node SDK, created spans for build/deploy steps, sent trace data to Dynatrace using OTLP. Designed all steps (install, build, test, deploy) to be inside OTel traces.                                                                                    |   |                                                                                                                                                   |
| 2     | *Node modules not found in deployment step*               | Azure App Service container failed to start: missing `node-fetch` and other dependencies; `Cannot find module 'node-fetch'...` error.                   | Confirmed `node_modules` was excluded from artifact zip; fixed by **adding `npm ci` in deploy stage** (after unzipping artifact) to always install dependencies before running app/scripts in Azure.                                                                                                  |   |                                                                                                                                                   |
| 3     | *Missing npm install before pipeline trace script*        | `pipeline-trace.js` failed in build/deploy job if dependencies weren't installed, since steps ran before any `npm ci`/`install`.                        | Added an explicit `npm ci` step **before** running `node pipeline-trace.js` in both build and deploy jobs of GitHub Actions workflow, ensuring required modules (including OTel) are present.                                                                                                         |   |                                                                                                                                                   |
| 4     | *Difference between `npm ci` and `npm install`*           | Unsure why `npm ci` is used instead of `npm install` in pipelines.                                                                                      | Documented: `npm ci` guarantees clean, reproducible builds based strictly on `package-lock.json`, is faster and more reliable for CI/CD, while `npm install` is more flexible for dev use. Adopted `npm ci` as default for all CI pipeline installs.                                                  |   |                                                                                                                                                   |
| 5     | *Failed Azure Deploy step: wrong CLI args*                | Tried using `az webapp deployment source config-zip ... --publish-profile ...` which threw unrecognized argument error.                                 | Switched to recommended [azure/webapps-deploy@v3](https://github.com/Azure/webapps-deploy) GitHub Action for deploying to Azure App Service; simplified deployment, handled publish profile securely.                                                                                                 |   |                                                                                                                                                   |
| 6     | *Container failed healthcheck on port 8080*               | Azure logs: “didn't respond to HTTP pings on port: 8080”. App wasn’t starting correctly.                                                                | Ensured `express` server listens on \`process.env.PORT                                                                                                                                                                                                                                                |   | 8080\`, checked startup logs for errors. Confirmed artifact included all code and dependencies, and port configuration in Azure matched Node app. |
| 7     | *Log ingestion: OTel JS SDK doesn't support logs*         | Wanted to ingest structured logs (with trace/span correlation) to Dynatrace via OpenTelemetry; OTel JS logging not yet GA/stable.                       | Built a custom log ingestion module (`logger.js`) that posts JSON logs to Dynatrace Log Ingest API, explicitly passing `trace_id` and `span_id` fields for correlation. Used `node-fetch` to POST logs after each pipeline stage, batch logs where needed.                                            |   |                                                                                                                                                   |
| 8     | *Log-trace correlation: batch logs for each stage*        | Needed all logs for Build and Deploy in single JSON payload, with trace and span info, sent at end of each stage for clean correlation in Dynatrace.    | Enhanced `pipeline-trace.js` to collect per-step logs (duration, status, error, trace\_id, span\_id, etc.), and at the end of build or deploy job, POST a single structured JSON log array to Dynatrace Log Ingest endpoint.                                                                          |   |                                                                                                                                                   |
| 9     | *Incorrect trace duration in Deploy (Azure)*              | The root Deploy trace span duration was much shorter (e.g., 2s) than actual Azure deploy step (e.g., 18s), because tracing script ran after deployment. | Used **environment variables** to capture deploy start/end timestamps in GitHub Actions: before and after Azure deployment. Passed these times to `pipeline-trace.js`, which then created the root Deploy span with correct duration by setting `startTime` and ending with `endTime` using OTel API. |   |                                                                                                                                                   |
| 10    | *Port mismatch or missing startup scripts in App Service* | Azure App Service failed to respond to health checks because app didn't start, often due to missing startup scripts or wrong port.                      | Ensured package.json had `"start": "node index.js"`, and `index.js` listens on \`process.env.PORT                                                                                                                                                                                                     |   | 8080\`. Also made sure all code and modules were present in deployment package and not excluded by mistake.                                       |
| 11    | *Clarify where to run npm install vs. npm ci*             | Wondered whether to run `npm ci` or `npm install`, and in which directories, for both build and deploy jobs.                                            | Standardized pipeline to run `npm ci` (never `npm install`) in both build and deploy jobs (after unzip), before any Node scripts are run. This avoids drift and "works on my machine" errors.                                                                                                         |   |                                                                                                                                                   |
| 12    | *Order of tracing in build job*                           | Unsure whether to call `pipeline-trace.js` early to cover dependency install and early build/test steps.                                                | Modified workflow so that tracing script (`node pipeline-trace.js Build`) runs **immediately after dependencies are installed** but before any other build/test commands, ensuring all stages are measured as OTel spans for end-to-end pipeline visibility.                                          |   |                                                                                                                                                   |
| 13    | *Root cause diagnosis and issue log table*                | Needed a record of all troubleshooting and fixes for future reference and team knowledge sharing.                                                       | Created a detailed table (this!) with each issue, background, context, and the resolution/fix that worked.                                                                                                                                                                                            |   |                                                                                                                                                   |

---

## **Summary**

* **All issues and design choices are now documented.**
* You now have reproducible, traceable, and log-correlated CI/CD pipelines with Dynatrace observability, using OTel for traces and Log Ingest API for logs.
* Your YAML is robust: runs `npm ci` where needed, installs modules before scripts, and batches logs for perfect trace-log correlation.

---

### **Tips for Future**

* If you change or upgrade Node.js, update all `setup-node` steps.
* Always keep `package-lock.json` committed and in sync with `package.json`.
* Keep the custom log ingestion logic in sync with Dynatrace's log schema (trace\_id, span\_id) for best visibility.
* Consider adding health checks and post-deploy validations in the pipeline for production confidence.